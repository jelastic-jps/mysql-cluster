type: update
name: Database Monitoring
id: db-monitoring

description:
  text:  The Database Monitoring add-on performs a comprehensive monitoring of your MySQL/MariaDB/Percona Database to detect data corruption and inconsistency in the components. Add-on will **temporarily stop all database services** for the duration of the diagnostic to ensure accurate results. Detected issues will be listed in the recovery log.
  short: The add-on checks your database for corrupted or inconsistent data in the components.

logo: /images/database-monitoring.png

baseUrl: https://raw.githubusercontent.com/sych74/mysql-cluster/JE-66040/addons/monitoring

mixins:
  - https://cdn.jsdelivr.net/gh/jelastic-jps/mysql-cluster@3.0.0/scripts/common.yml

targetNodes:
  nodeType:
    - mysql
    - mariadb-dockerized
    - mariadb
    - perconadb

settings:
  main:
    submitUnchanged: true
    fields:
      - name: monitorInterval
        caption: Monitoring interval
        type: list
        editable: false
        values:
          - value: 5
            caption: Every 5 minutes
          - value: 10
            caption: Every 10 minutes
          - value: 15
            caption: Every 15 minutes
          - value: 20
            caption: Every 20 minutes
          - value: 30
            caption: Every 30 minutes
          - value: 40
            caption: Every 40 minutes
          - value: 50
            caption: Every 50 minutes
        default: 10

buttons:
  - name: Configure
    caption: Configure
    action: configure
    settings: main
    loadingText: Configuring...
    successText: The monitoring configs have been updated successfully.

globals:
  scriptSufix: db-monitoring

onAfterClone:
  install: ${baseUrl}/manifest.yml?_r=${fn.random}
  envName: ${event.response.env.envName}
  nodeGroup: ${targetNodes.nodeGroup}
  settings:
    install: true
    monitorInterval: ${settings.monitorInterval}

onInstall:
  - if (!${settings.install:false}): init
  - downloadMonitoringScript
  - createMonitoringScript
  - createMonitoringSchedule

onUninstall:
  - removeMonitoringSchedule
  - removeMonitoringScript
  - removeMonitoringBinary

onBeforeDelete:
  - removeMonitoringSchedule
  - removeMonitoringScript
  - removeMonitoringBinary

actions:
  init:
    log: Monitoring is initialized

  downloadMonitoringScript:
    - cmd[sqldb]: |-
        curl -fsSL ${baseUrl}/scripts/db-monitoring.sh -o /usr/local/sbin/db-monitoring.sh && chmod +x /usr/local/sbin/db-monitoring.sh
      user: root

  createMonitoringScript:
    script: |
      let Response = com.hivext.api.Response;
      let Transport = com.hivext.api.core.utils.Transport;
      let scriptBody = new Transport().get("${baseUrl}/scripts/db-monitoring.js");
      let scriptName = "${env.name}-${globals.scriptSufix}";

      var resp = api.dev.scripting.GetScript(appid, session, scriptName);
      if (resp.result == Response.OK) {
        api.dev.scripting.DeleteScript(appid, session, scriptName);
      }

      resp = api.dev.scripting.CreateScript(appid, session, scriptName, "js", scriptBody);
      if (resp.result != 0) return resp;
      java.lang.Thread.sleep(500);
      resp = api.dev.scripting.Build(appid, session, scriptName);
      if (resp.result != 0) return resp;
      return { result: 0 };

  createMonitoringSchedule:
    script: |
      let scriptName = "${env.name}-${globals.scriptSufix}";
      let trigger = "cron:0 0/${settings.monitorInterval} * ? * * *";

      var tasks = api.utils.scheduler.GetTasks({ appid: appid, session: session }).objects;
      for (var i = 0, l = tasks.length; i < l; i++) {
        if (tasks[i].script == scriptName) {
          api.utils.scheduler.RemoveTask({ appid: appid, session: session, id: tasks[i].id });
        }
      }

      return api.utils.scheduler.CreateEnvTask({
        appid: appid,
        envName: "${env.name}",
        session: session,
        script: scriptName,
        trigger: trigger,
        description: "Run DB monitoring",
        params: { envName: "${env.name}" }
      });

  removeMonitoringSchedule:
    script: |
      let scriptName = "${env.name}-${globals.scriptSufix}";
      let tasks = api.utils.scheduler.GetTasks({ appid: appid, session: session }).objects;
      for (var i = 0, l = tasks.length; i < l; i++) {
        if (tasks[i].script == scriptName) {
          api.utils.scheduler.RemoveTask({ appid: appid, session: session, id: tasks[i].id });
        }
      }
      return { result: 0 };

  removeMonitoringScript:
    script: |
      let scriptName = "${env.name}-${globals.scriptSufix}";
      var resp = api.dev.scripting.GetScript(appid, session, scriptName);
      if (resp.result == com.hivext.api.Response.OK) {
        api.dev.scripting.DeleteScript(appid, session, scriptName);
      }
      return { result: 0 };

  removeMonitoringBinary:
    - cmd[sqldb]: |-
        rm -f /usr/local/sbin/db-monitoring.sh || true
      user: root

  configure:
    - createMonitoringSchedule
