type: update
name: Database Monitoring
id: db-monitoring

description:
  text:  The Database Monitoring add-on performs a comprehensive monitoring of your MySQL/MariaDB/Percona Database to detect data corruption and inconsistency in the components. Add-on will **temporarily stop all database services** for the duration of the diagnostic to ensure accurate results. Detected issues will be listed in the recovery log.
  short: The add-on checks your database for corrupted or inconsistent data in the components.

logo: /images/database-monitoring.png

baseUrl: https://raw.githubusercontent.com/sych74/mysql-cluster/JE-66040/addons/monitoring

mixins:
  - https://cdn.jsdelivr.net/gh/jelastic-jps/mysql-cluster@3.0.0/scripts/common.yml

targetNodes:
  nodeType:
    - mysql
    - mariadb-dockerized
    - mariadb
    - perconadb

settings:
  submitUnchanged: true
  fields:
    - name: user
      caption: User
      type: string
      required: true
    - name: password
      caption: Password
      type: string
      inputType: password
      required: true

onAfterClone:
  install: ${baseUrl}/manifest.yml?_r=${fn.random}
  envName: ${event.response.env.envName}
  nodeGroup: ${targetNodes.nodeGroup}
  settings:
    install: true
    user: ${settings.user}
    password: ${settings.password}

onInstall:
  - if (!${settings.install:false}): authValidate
  - getReplicaUser
  - if (!${settings.install:false}): init
  - setupCron

actions:
  authValidate:
    - forEach(i:nodes.sqldb):
      - cmd[${@i.id}]: mysqladmin ping -u${settings.user} -p${settings.password} 2>/dev/null 1>/dev/null; MYSQLD_RUNNING=${?}; echo ${MYSQLD_RUNNING};
      - if ('${response.out}' == '0'):
        - cmd[${@i.id}]: mysql -u${settings.user} -p${settings.password} -e "EXIT" 2>/dev/null 1>/dev/null; MYSQLD_RUNNING=${?}; echo ${MYSQLD_RUNNING};
        - if ('${response.out}' != '0'):
            return:
              type: warning
              message: Authentication failed, please check User/Password.
              
  init:
    log: Monitoring is initialized
  
  setupCron:
    - cmd[sqldb]: |-
        curl -fsSL ${baseUrl}/scripts/db-monitoring.sh -o /usr/local/sbin/db-monitoring.sh && chmod +x /usr/local/sbin/db-monitoring.sh && echo "* * * * * root /usr/local/sbin/db-monitoring.sh >/dev/null 2>&1" > /etc/cron.d/db-monitoring && chmod 644 /etc/cron.d/db-monitoring && (systemctl reload crond 2>/dev/null || systemctl reload cron 2>/dev/null || service crond reload 2>/dev/null || service cron reload 2>/dev/null || true)
      user: root
