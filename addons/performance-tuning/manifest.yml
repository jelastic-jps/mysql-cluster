type: update
name: DB Cluster Tuning (Alpha)
id: proxysql-db-tune-addon
logo: addons/performance-tuning/images/mysql-proxysql-tuning.png
description: Change ProxySQL and Database settings according to your particular use case
baseUrl: https://raw.githubusercontent.com/sych74/mysql-cluster/JE-66111

responses:
  99:
    type: warning
    message: Add-on does not provide performance tuning for a non-cluster topologies.

onInstall:
  - if (!nodes.proxy):
      return:
        type: warning
        message: Add-on does not provide performance tuning without ProxySQL nodes.
  
  - script: |
        var nodeGroups, resp, scheme = "", actions = [], jps;
        resp = api.env.control.GetNodeGroups("${env.name}", session);
        if (resp.result != 0) return resp;
        nodeGroups = resp.object;
        for (var i = 0, n = nodeGroups.length; i < n; i++) {
          if (nodeGroups[i].name == 'sqldb' && nodeGroups[i].cluster && nodeGroups[i].cluster.enabled && nodeGroups[i].cluster.settings.scheme) {
            scheme = String(nodeGroups[i].cluster.settings.scheme);
          }
        }
        if (scheme !== "master" && scheme !== "slave" && scheme !== "galera") return 99;
        return api.marketplace.jps.Install({
            jps: "https://raw.githubusercontent.com/sych74/mysql-cluster/JE-66111/addons/performance-tuning/scripts/slave.jps",
            envName: "${env.envName}",
            nodeGroup: "proxy"
        })
        
